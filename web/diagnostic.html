<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="">
<meta name="author" content="Mark Otto, Jacob Thornton, and Bootstrap contributors">
<meta name="generator" content="Jekyll v3.8.6">
<title>Diagnostic</title>

<script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.3/Chart.min.js"></script>
<!-- script src="dashboard.js"></script -->
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/feather-icons/4.9.0/feather.min.js"></script>

<!-- Favicons -->
<style>
.bd-placeholder-img {
    font-size: 1.125rem;
    text-anchor: middle;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
}

@media (min-width: 768px) {
    .bd-placeholder-img-lg {
        font-size: 3.5rem;
    }
}
</style>
<!-- Custom styles for this template -->
<link href="dashboard.css" rel="stylesheet">

</head>
<body data-spy="scroll">
    <nav class="navbar navbar-dark fixed-top bg-dark flex-md-nowrap p-0 shadow">
        <a class="navbar-brand col-sm-3 col-md-2 mr-0" href="#">Batch & Processing</a>
        <input class="form-control form-control-dark w-100" type="text" value="ARIP.OSJS.JOB.InventaireCMDBCheck" placeholder="jobName" aria-label="Search" id="jobName">
        <input class="form-control form-control-dark w-100" type="text" value="VA1" placeholder="" aria-label="Search" id="instanceId">
        <ul class="navbar-nav px-3">
            <li class="nav-item text-nowrap">
                <button type="button" class="btn btn-info" id="Info">Info</button>
            </li>
        </ul>
    </nav>

<div class="container-fluid">
    <div class="row">
        <nav class="col-md-2 d-none d-md-block bg-light sidebar">
            <div class="sidebar-sticky">
            <ul class="nav flex-column">
              <li class="nav-item">
                <a class="nav-link" href="#STATUS">
                  <span data-feather="activity"></span>
                  Status 
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="#LOGS">
                  <span data-feather="file-text"></span>
                  Logs
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="#EVENTS">
                  <span data-feather="clock"></span>
                  Events
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="#RUNS">
                  <span data-feather="bar-chart-2"></span>
                  Runs
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="#CONFIG">
                  <span data-feather="edit"></span>
                  Config 
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="#AUDIT">
                  <span data-feather="shield"></span>
                  Audit
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="#BOX">
                  <span data-feather="box"></span>
                  Box
                </a>
              </li>
            </ul>
        </div>
    </nav>

    <main role="main" class="col-md-9 ml-sm-auto col-lg-10 px-4">
        <div id="STATUS" class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
            <h1 class="h2">Status</h1>
            <div class="btn-toolbar mb-2 mb-md-0">
                <div class="btn-group mr-2">
                    <div id="ContentButton">?</div>                    
                </div>
            </div>
        </div>
        <form id="formStatus">
            <div class="form-group row">
                <label for="lastStart" class="col-sm-1 col-form-label">Last start</label>
                <div class="col-sm-3">
                    <input type="text" class="form-control" id="lastStart" value="">
                </div>
                <label for="jobId" class="col-sm-1 col-form-label">Job Id</label>
                <div class="col-sm-2">
                    <input type="text" class="form-control" id="jobId" value="">
                </div>
            </div>
            <div class="form-group row">
                <label for="lastEnd" class="col-sm-1 col-form-label">Last end</label>
                <div class="col-sm-3">
                    <input type="text" class="form-control" id="lastEnd" value="">
                </div>
                <label for="runMachine" class="col-sm-1 col-form-label">Machine</label>
                <div class="col-sm-2">
                    <input type="text" class="form-control" id="runMachine" value="">
                </div>
            </div>
            <hr/>
            <div class="form-group row">
                <label for="nextStart" class="col-sm-1 col-form-label">Next start</label>
                <div class="col-sm-2">
                    <input type="text" class="form-control" id="nextStart" value="">
                </div>
                <label for="exitCode" class="col-sm-1 col-form-label">Exit code</label>
                <div class="col-sm-2">
                    <input type="text" class="form-control" id="exitCode" value="">
                </div>
            </div>
            <div class="form-group row">
                <label for="jobDescription" class="col-sm-1 col-form-label">Description</label>
                <div class="col-sm-11">
                    <input type="input" class="form-control" id="jobDescription">
                </div>
            </div>
            <div class="form-group row">
                <label for="jobCommand" class="col-sm-1 col-form-label">Command</label>
                <div class="col-sm-11">
                    <input type="input" class="form-control" id="jobCommand">
                </div>
            </div>
            <hr/>
            <div class="form-group row">
                <label for="boxName" class="col-sm-1 col-form-label">Box name</label>
                <div class="col-sm-11">
                    <input type="input" class="form-control" id="boxName">
                </div>
            </div>
        </form>
	  
        <div id="DETAIL" class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">Detail</h1>
        </div>
        <div id="ContentDetail"></div> 

        <div id="LOGS" class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">Logs</h1>
        </div>
        <div id="ContentOUT"></div>              
        <div id="ContentERR"></div>              
        
        <div id="EVENTS" class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">Events</h1>
        </div>
        <div id="ContentReport"></div> 
        <!-- canvas class="my-4 w-100" id="myChart" width="900" height="380"></canvas -->

        <div id="RUNS" class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">Runs</h1>
        <div id="ContentRuntimes"></div> 
        </div>
        <div id="ContentRuns"></div> 

        <div id="CONFIG" class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">Config</h1>
        </div>
        <div id="ContentCode"></div> 

        <div id="AUDIT" class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">Audit</h1>
        </div>
        <div id="ContentAudit"></div> 

        <div id="BOX" class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2"></h1>
        </div>	  
    </main>
</div>
</div>
<script type="text/javascript">
feather.replace();
const urlParams = new URLSearchParams(window.location.search);
const jobName = urlParams.get('jobName');
const instanceId = urlParams.get('instanceId');
const jobId = urlParams.get('jobId');
const lastStart = urlParams.get('lastStart');
const lastEnd = urlParams.get('lastEnd');
const runMachine = urlParams.get('runMachine');
const jobStatus = urlParams.get('jobStatus');
$('#jobName').val(jobName);
$('#instanceId').val(instanceId);
$('#jobId').val(jobId);
$('#lastStart').val(lastStart);
$('#lastEnd').val(lastEnd);
$('#runMachine').val(runMachine);
$(document).ready($('#Info').click(Diag()));

function colorStatus(response) {
    switch (response) {
            case 'FAILURE':
                    status = 'danger';
                    break;
            default:
                    status = response.toLowerCase();
    }
    return status;
}

function Diag() {
    var jobName = $('#jobName').val();
    var instanceId = $('#instanceId').val();
    var api = "http://"+window.location.hostname+"/api/v1/bundles/ats/instances/"+instanceId;

    // Detail
    $.ajax({
            url: api+"/jobs/"+jobName+"/detail.txt",
            dataType: "text",
            type: 'GET',
            jsonpCallback: 'callback',
            crossDomain: true,
            success: function(response) {
                $('#ContentDetail').html('<pre>'+response+'</pre>');
            }
    });
    $.ajax({
            url: api+"/jobs/"+jobName+"/status.json",
            dataType: "json",
            type: 'GET',
            jsonpCallback: 'callback',
            crossDomain: true,
            success: function(response) {
                $('#ContentButton').html('<div class="alert alert-'+colorStatus(response.status)+'" role="alert" id="Status">'+response.status+'</div>');                
                $('#nextStart').val(response.nextStart);
                $('#exitCode').val(response.exitCode);
                $('#jobDescription').val(response.description);
                $('#jobCommand').val(response.command);
                $('#boxName').val(response.boxName);
            }
    });

    // Report
    $.ajax({
            url: api+"/jobs/"+jobName+"/report.txt",
            dataType: "text",
            type: 'GET',
            jsonpCallback: 'callback',
            crossDomain: true,
            success: function(response) {
                $('#ContentReport').html('<pre>'+response+'</pre>');
            }
    });

    // Logs
    $.ajax({
            url: api+"/jobs/"+jobName+"/logs/Out.txt",
            dataType: "text",
            type: 'GET',
            jsonpCallback: 'callback',
            crossDomain: true,
            success: function(response) {
                out = response;
                $('#ContentOUT').html('<pre>'+out+'</pre>');
                $.ajax({
                        url: api+"/jobs/"+jobName+"/logs/Error.txt",
                        dataType: "text",
                        type: 'GET',
                        jsonpCallback: 'callback',
                        crossDomain: true,
                        success: function(response) {
                            if (response !== out)
                                $('#ContentERR').html('<h2>Error</h2><pre>'+response+'</pre>');
                        }
                });
            }
    });

    // Config
    $.ajax({
            url: api+"/jobs/"+jobName+"/code.txt",
            dataType: "text",
            type: 'GET',
            jsonpCallback: 'callback',
            crossDomain: true,
            success: function(response) {
                    $('#ContentCode').html('<pre>'+response+'</pre>');
            }
    });
    
    // Runtimes
    $('#ContentRuntimes').html('<img src="'+api+"/jobs/"+jobName+"/runtimes.png"+'"/>');
    
    // Runs
    $.ajax({
            url: api+"/jobs/"+jobName+"/runs.txt",
            dataType: "json",
            type: 'GET',
            jsonpCallback: 'callback',
            crossDomain: true,
            success: function(response) {
                    var Runs = '<table class="table table-striped table-sm"><thead><tr><th>Start</th><th>End</th><th>Status</th><th>Duration</th><th>Machine</th><th>Exit</th></tr></thead><tbody>';
                    $.each(response, function(index, element) {
                            // Attention au NOEXEC
                            if (element.runMachine=='** NOEXEC **') 
                                status = 'warning';
                            else 
                                status = element.status;
                            Runs += '<tr class="table-'+colorStatus(status)+'">'
                            +'<td>'+element.startTime+'</td>'
                            +'<td>'+element.endTime+'</td>'
                            +'<td>'+element.status+'</td>'
                            +'<td>'+element.duration+'</td>'
                            +'<td>'+element.runMachine+'</td>'
                            +'<td>'+element.exitCode+'</td></tr>'
                    });
                    Runs += '</tbody></table>';
                    $('#ContentRuns').html(Runs);				
            }
    });
    
    // Audit
    $.ajax({
            url: api+"/jobs/"+jobName+"/audit.txt",
            dataType: "text",
            type: 'GET',
            jsonpCallback: 'callback',
            crossDomain: true,
            success: function(response) {
                $('#ContentAudit').html('<pre>'+response+'</pre>');
            }
    });
    
};
</script>
</body>
</html>
