<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="">
<meta name="author" content="Mark Otto, Jacob Thornton, and Bootstrap contributors">
<meta name="generator" content="Jekyll v3.8.6">
<title>Doc</title>

<script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.3/Chart.min.js"></script>
<!-- script src="dashboard.js"></script -->
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/feather-icons/4.9.0/feather.min.js"></script>

<!-- Calendrier 
https://github.com/year-calendar/js-year-calendar -->
<script src="https://unpkg.com/js-year-calendar@latest/dist/js-year-calendar.min.js"></script>
<link rel="stylesheet" type="text/css" href="https://unpkg.com/js-year-calendar@latest/dist/js-year-calendar.min.css" />
<script src="https://unpkg.com/js-year-calendar@latest/locales/js-year-calendar.fr.js"></script>
<!-- Favicons -->
<style>
.bd-placeholder-img {
    font-size: 1.125rem;
    text-anchor: middle;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
}

@media (min-width: 768px) {
    .bd-placeholder-img-lg {
        font-size: 3.5rem;
    }
}

.blockquote {
    border: 1px solid #b3b3b3;
    border-left: 5px solid #b3b3b3;
    border-radius: 0px;
    background: #fafafa;
    margin: 10px;
    padding: 10px 20px;
    font-size: 1em;
}
</style>
<!-- Custom styles for this template -->
<link href="dashboard.css" rel="stylesheet">

</head>
<body data-spy="scroll">
    <nav class="navbar navbar-dark fixed-top bg-dark flex-md-nowrap p-0 shadow">
        <a class="navbar-brand col-sm-3 col-md-2 mr-0" href="#">Batch & Processing</a>
        <input class="form-control form-control-dark w-100" type="text" value="ARIP.OSJS.JOB.InventaireCMDBCheck" placeholder="jobName" aria-label="Search" id="jobName">
        <input class="form-control form-control-dark w-100" type="text" value="VA1" placeholder="" aria-label="Search" id="instanceId">
        <ul class="navbar-nav px-3">
            <li class="nav-item text-nowrap">
                <button type="button" class="btn btn-info" id="Info">Info</button>
            </li>
        </ul>
    </nav>

<div class="container-fluid">
    <div class="row">
        <nav class="col-md-2 d-none d-md-block bg-light sidebar">
            <div class="sidebar-sticky">
            <ul class="nav flex-column">
              <li class="nav-item">
                <a class="nav-link" href="#BOX">
                  <span data-feather="package"></span>
                  Box
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="#JOBS">
                  <span data-feather="check-square"></span>
                  Jobs
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="#SCHEMA">
                  <span data-feather="share-2"></span>
                  Schema
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="#CALENDARS">
                  <span data-feather="calendar"></span>
                  Calendars
                </a>
              </li>
            </ul>
        </div>
    </nav>
        
    <main role="main" class="col-md-9 ml-sm-auto col-lg-10 px-4">
        <div id="BOX" class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
            <h1 class="h2" id="boxName"></h1>
            <div class="btn-toolbar mb-2 mb-md-0">
            </div>
        </div>
        
        <div id="Definition"></div> 
        <div id="JOBS" class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
            <h1 class="h2">Jobs</h1>
        </div>
	<div id="schemaJobs"></div>        
        <div id="ContentBox"></div> 
        
        <div id="SCHEMA" class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">Schema</h1>
        </div>
        <div id="svgLink"></div>
	<div id="schema"></div>
	<div id="maps"></div>

        <div id="Calendars"></div> 
        <div id="CALENDARS" class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
            <h1 class="h2">Calendars</h1>
        </div>
        <div data-provide=".calendar" class="calendar"></div>
        
    </main>
</div>
</div>
<script type="text/javascript">
calendar = new Calendar('.calendar', {
    language: 'en'
/*    
    dataSource: [
        {
            id: 0,
            name: 'Jour férié',
            location: 'San Francisco, CA',
            startDate: new Date("2020-01-03T00:00:00+00:00"),
            endDate: new Date("2020-01-03T00:00:00+00:00"),
            color: 'green'
        }
    ]
*/
})

feather.replace();
const urlParams = new URLSearchParams(window.location.search);
const jobName = urlParams.get('jobName');
const instanceId = urlParams.get('instanceId');
const jobId = urlParams.get('jobId');
const lastStart = urlParams.get('lastStart');
const lastEnd = urlParams.get('lastEnd');
const runMachine = urlParams.get('runMachine');
const jobStatus = urlParams.get('jobStatus');
const apiAck = "http://devc8138fkl/api/v1/bundles/ack";
const api = "http://devc8138fkl/api/v1/bundles/ats/instances/"+instanceId;
$('#boxName').html(jobName);
$('#jobName').val(jobName);
$('#instanceId').val(instanceId);

$(document).ready($('#Info').click(Doc()));

function colorStatus(status) {
    switch (status) {            
            case 'SUCCESS':
                color = 'success';
                break;
            case 'FAILURE':
                color = 'danger';
                break;
            case 'INACTIVE':
                color = 'secondary';
                break;
            default:
                color = 'dark';
    }
    return color;
}

function colorAlarm(status) {
    switch (status) {            
            case 'JOBFAILURE':
                color = 'danger';
                break;
            default:
                color = 'dark';
    }
    return color;
}

function Job(idx, element, level) {
    var text = '<a name="'+element.jobName+'"><h3>'+element.jobName+' <span class="badge badge-pill badge-'+colorStatus(element.status)+'">'+element.status+'</span></h3></name>';
    text += '<p>'+element.description+'</p>';
    text += '<h4>Instructions</h4><div id="instructions'+element.jobId+'"></div>';
    
    var url= apiAck+"/jobs/"+element.jobName+"/instructions.json";
    // Instructions
    $.ajax({
        url: url,
        dataType: "text",
        type: 'GET',
        jsonpCallback: 'callback',
        crossDomain: true,
        success: function(response) {
            var data = JSON.parse(response)
            var instructions = '';
            $.each(data, function (k, inst) {
                instructions += '<div class="card">';
                instructions += '<div class="card-header">';
                instructions += '<span class="badge badge-'+colorAlarm(inst.status)+'">'+inst.status+' </span>';
                if (typeof inst.pexit !== 'undefined')
                    instructions += ' (Exit <p>'+inst.pexit+'</p>)';
                instructions += '</div>';
                instructions += '<div class="card-body">';
                instructions += '<h5 class="card-title">'+inst.name+'</h5>';
                instructions += '<p class="card-text">'+inst.to_do+'</p>';
                instructions += 'From <b>'+inst.msg_from+'</b>';
                instructions += ' To <b>'+inst.msg_to+'</b>';
                if (typeof inst.msg_cc !== 'undefined')
                    instructions += ' cc <b>'+inst.msg_cc+'</b>';
                instructions += '</div>';                   
                instructions += '<div class="card-footer text-muted"><i>Pattern '+inst.pattern+'</i></div>';
                instructions += '<div class="progress">';
                instructions += '<div class="progress-bar bg-info" role="progressbar" style="width: '+inst.percent+'%" aria-valuenow="20" aria-valuemin="0" aria-valuemax="100"></div>';
                instructions += '</div>';
                instructions += '</div>';
                instructions += '<br/>';
            });
           $('#instructions'+element.jobId).html(instructions);
        }
    });
    text += '<h4>Technical data</h4>';
    if (element.jobType==='BOX') {
        
    }
    else if (element.jobType==='CMD') { 
        text += '<dl class="dl-horizontal">';
        text += '<dt>Command</dt><dd>'+element.command+'</dd>';
        text += '<dt>User</dt><dd>'+element.owner+'</dd>';
        text += '<dt>Machine</dt><dd>'+element.runMachine+'</dd>';
        text += '</dl>';
        
/*
        text += '<table class="table table-striped w-auto text-xsmall"><tbody>'
        text += '<tr><th scope="row">Command</th><td>'+element.command+'</td></tr>';
        text += '<tr><th scope="row">User</th><td>'+element.owner+'</td></tr>';
        text += '<tr><th scope="row">Machine</th><td>'+element.runMachine+'</td></tr>';
        text += '</table>';
*/
    }
    // si il y a des enfants
    if (typeof element.children !== 'undefined') {
        text += '<blockquote class="blockquote">';
        text += '<img src="'+api+"/boxes/"+element.jobName+"/jobs.png"+'?dependencies=1&depth=0" class="float-right" USEMAP="#map'+element.jobName+'" />';    
        // Mapping
        $.ajax({
                url: api+"/boxes/"+element.jobName+"/jobs.cmap?dependencies=1&depth=0",
                dataType: "text",
                type: 'GET',
                jsonpCallback: 'callback',
                crossDomain: true,
                success: function(response) {
                    $('#maps').append('<map name="map'+element.jobName+'">'+response+'</map>');
                }
        });
        level++;
        $.each(element.children, function (index, child ) {
            text += Job (index, child, level);
        });
        text += '</blockquote>';
    }
    return text;
}

function Doc() {
    var jobName = $('#jobName').val();
    var instanceId = $('#instanceId').val();

    $.ajax({
            url: api+"/jobs/"+jobName+"/status.json",
            dataType: "json",
            type: 'GET',
            jsonpCallback: 'callback',
            crossDomain: true,
            success: function(response) {
                var text = '<blockquote class="blockquote">'+response.description+'</blockquote>'
                text += '<table class="table table-striped table-sm"><tbody>'
                text += '<tr><th scope="row">Status</th><td><span class="badge badge-pill badge-'+colorStatus(response.status)+'">'+response.status+'</span></td><th scope="row">Last start</th><td>'+response.lastStart+'</td></tr>';
                text += '<tr><th scope="row">Next start</th><td>'+response.nextStart+'</td><th scope="row">Last end</th><td>'+response.lastEnd+'</td></tr>';
                // Date conditions ?
                if (response.boxName !== ' ') {
                    text += '<tr><th scope="row">Box name</th><td>'+response.boxName+'</td></tr>';
                }
                text += '<tr><th scope="row">Calendar</th><td>';
                if (typeof response.runCalendar !== 'undefined') {
                    text += response.runCalendar;
                    Calendar(response.runCalendar, 'green');
                }
                text += '</td><th scope="row">Exclude</th><td>'
                if (typeof response.excludeCalendar !== 'undefined') {
                    text += response.excludeCalendar;
                    Calendar(response.excludeCalendar, 'red');
                }
                text += '</td></tr>';
                text += '</tbody></table>'
                $('#Definition').html(text);                
            }
    });

    $('#schemaJobs').html('<img src="'+api+"/boxes/"+jobName+"/jobs.png"+'?dependencies=1&depth=0" class="float-right" USEMAP="#map'+jobName+'" />');    
    // Mapping
    $.ajax({
            url: api+"/boxes/"+jobName+"/jobs.cmap?dependencies=1&depth=0",
            dataType: "text",
            type: 'GET',
            jsonpCallback: 'callback',
            crossDomain: true,
            success: function(response) {
                $('#maps').html('<map name="map'+jobName+'">'+response+'</map>');
            }
    });

    // Jobs
    $.ajax({
            url: api+"/boxes/"+jobName+"/jobs.json?dependencies=1&depth=99",
            dataType: "text",
            type: 'GET',
            jsonpCallback: 'callback',
            crossDomain: true,
            success: function(response) {
                var data = JSON.parse(response)
                var text = '';
                $.each(data, function (index, element) {
                    text += Job(index, element, 0);
                });
                $('#ContentBox').append(text);
            }
    });

    // Schema global
    $('#schema').html('<img src="'+api+"/boxes/"+jobName+"/jobs.png"+'?dependencies=1&depth=99" class="img-fluid" USEMAP="#schemaMap" />');        
    // Lien vers un SVG pour la navigation
    $('#svgLink').html('<a href="'+api+"/boxes/"+jobName+"/jobs.svg"+'?dependencies=1&depth=99" target="_blank">SVG</a>'); 
       
function Calendar(name,color) {
    $.ajax({
            url: api+"/calendars/"+name+"/days.json",
            dataType: "json",
            type: 'GET',
            jsonpCallback: 'callback',
            crossDomain: true,
            success: function(days) {
                $.each(days, function (k, cal) {
                    calendar.addEvent({
                        name: name,
                        startDate: new Date(cal.day),
                        endDate: new Date(cal.day),
                        color: color
                    });
                });
            }
    });
}

};


</script>
</body>
</html>
